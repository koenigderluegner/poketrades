import{a as R,b as C}from"./chunk-NQ2U5RJ5.js";import{p as L,q as K}from"./chunk-NGMT7MAL.js";import{Aa as k,Cc as E,Dc as x,Fc as N,Gc as $,R as y,X as S,_ as T,ba as g,fa as _,g as P,ga as M,k as b,o as A,oa as D}from"./chunk-OADD6RND.js";import{a as O,b as H}from"./chunk-ESJYUATY.js";var F=(()=>{let o=class o{constructor(){this._httpClient=g(K),this._spreadsheetFields=["spreadsheetId","properties.title","sheets.properties","sheets.properties.sheetId","sheets.properties.title","sheets.properties.gridProperties.rowCount","sheets.properties.gridProperties.frozenRowCount","sheets.properties.gridProperties.columnCount","sheets.properties.gridProperties.frozenColumnCount"]}getSpreadsheet(t,e){return this._httpClient.get(`https://sheets.googleapis.com/v4/spreadsheets/${t}?includeGridData=false&fields=${this._spreadsheetFields.join(",")}&key=${e}`)}getBatchValues(t,e,r){let n=new L;for(let a of e)n=n.append("ranges",a);return this._httpClient.get(`https://sheets.googleapis.com/v4/spreadsheets/${t}/values:batchGet?key=${r}`,{params:n})}};o.\u0275fac=function(e){return new(e||o)},o.\u0275prov=S({token:o,factory:o.\u0275fac,providedIn:"root"});let h=o;return h})();var I=new T("API_KEY");function j(h){return h?.injector||M(j),$(H(O({},h),{loader:void 0,stream:o=>{let B,t=()=>B.unsubscribe();o.abortSignal.addEventListener("abort",t);let e=k({value:void 0}),r,n=new Promise(i=>r=i);function a(i){e.set(i),r?.(e),r=void 0}return B=h.loader(o).subscribe({next:i=>a({value:i}),error:i=>a({error:i}),complete:()=>{r&&a({error:new Error("Resource completed before producing a value")}),o.abortSignal.removeEventListener("abort",t)}}),n}}))}var U=(()=>{let o=class o{constructor(){this.apiKey=g(I),this.injector=g(D),this.spreadsheet=void 0,this.gss=g(F),this.slugifyPipe=g(R),this.bannedSheets=["Welcome","Living Dex","Shiny Living Dex","Breedables Overview","Alcremie","Tool:Breeding","Tool: Move Lookup","Breedables Ball Legality","Ban Checker","DB:Abilities","DB:Balls","DB:Pokemon","DB:LevelMoves","DB:Items","DB:Misc","DB:Moves","DB:Types","DB:Natures","Resource Gen7 (Backup)","Ban List"],this.possibleHeaders=["dex","name","ability","owned","hasHA","ratio","move1","move2","move3","move4","nature","ball","gender","ot","amount","notes","event","isShiny","level","hp","atk","def","spa","spd","spe","item","id","dates","proof","tradeHistory","disclosure","lang","evhp","evatk","evdef","evspa","evspd","evspe","regularOwned","shinyOwned","slug"],this.allowedConfigs={type:["Valuables","Breedables","livingDex"],subType:["RNGs","Legendaries","Shinies","Competitives","Events"],ball:["Dream","Safari","Sport","Beast","Fast","Moon","Heavy","Love","Lure","Level","Friend","Pok\xE9","Great","Ultra","Premier","Dive","Luxury","Nest","Net","Repeat","Timer","Quick","Dusk","Heal"],includeShinies:["true","false"]}}getSpreadsheet(t,e){let r;return _(this.injector,()=>j({request:()=>({spreadsheetId:t()}),loader:({request:n})=>n.spreadsheetId?this.gss.getSpreadsheet(n.spreadsheetId,e).pipe(y(a=>{if(!n.spreadsheetId)return b();r={id:t(),title:a.properties.title,worksheets:[],livingDexChecklist:[]},this.spreadsheet=r;let i=a.sheets.filter(c=>!this.bannedSheets.includes(c.properties.title));return this._getWorksheets(t,i).pipe(y(c=>(r.worksheets=c,this.spreadsheet=r,b(r))),A(c=>{for(let s of c.worksheets)if(s.data){if(s.ownedEntries=(s.data??[]).filter(p=>p.isOwned).length,s.config?.type==="Valuables"&&s.config?.subType==="Shinies")for(let p of s.data)p.isShiny=!0;if(s.config?.type==="Breedables"&&s.config?.ball)for(let p of s.data)p.ball=s.config?.ball}return c.hasBreedables=c.worksheets.some(s=>s.config?.type==="Breedables"),c.hasValuables=c.worksheets.some(s=>s.config?.type==="Valuables"),c.hasBreedables&&(c.overviewEntries=this.buildOverviewEntries(c.worksheets.filter(s=>s.config?.type==="Breedables"&&s.config?.ball))),c}))})):b(void 0)}))}buildOverviewEntries(t){let e={};return t.forEach(r=>{let n=r.config?.ball?.toLowerCase(),a=r.data;n&&(e[n]={},a&&a.forEach(i=>{let c=i;e[n][c.iconSlug]=c}))}),e}getConfigs(t,e,r){return this.gss.getBatchValues(t(),e,this.apiKey).pipe(y(n=>{let a=[];for(let i of n.valueRanges){let c=i.values?.[0]?.indexOf("config")??-1;if(c===-1)continue;let s=i.values.map(l=>l[c]).filter(Boolean);s.shift();let p=this.getWorksheetConfig(s),v=i.range.split("!")[0],u=this.slugifySheetName(v),d=r.find(l=>this.slugifySheetName(l.properties.title)===u),m=0,f=0;if(i.values[0].some((l,w)=>{if(this.possibleHeaders.includes(l))return m=w,!0}),i.values[0].slice().reverse().some((l,w)=>{if(this.possibleHeaders.includes(l))return f=i.values[0].length-1-w,!0}),p.type!=="unknown"){p.colIndex={min:m,max:f};let l={id:"0",title:v,slug:u,config:p,gridProperties:d?.properties.gridProperties??{columnCount:0,rowCount:0},headerIndex:i.values[0].slice(m,f+1),valueRange:""},w=`${this.numberToColumnName(l.config?.colIndex.min??0)}${(l.gridProperties.frozenRowCount??0)+1}`,W=`${this.numberToColumnName(l.config?.colIndex.max??0)}${l.gridProperties.rowCount}`;l.valueRange=`${l.title}!${w}:${W}`,l.title=v.replace(/'/g,""),a.push(l)}}return b(a)}))}_getWorksheets(t,e){let r=e.map(n=>`${n.properties.title}!A1:ZZ5`);return this.getConfigs(t,r,e).pipe(y(n=>{let a=n.map(i=>i.valueRange);return this.getWorksheetValues(t,a,n)}))}numberToColumnName(t){let a="";for(;t>=0;)a=String.fromCharCode(t%26+97)+a,t=Math.floor(t/26)-1;return a.toUpperCase()}slugifySheetName(t){let e=this.slugifyPipe.transform(t);return e[0]==="'"&&(e=e.substr(1)),e[e.length-1]==="'"&&(e=e.substr(0,e.length-1)),e}getWorksheetConfig(t){let e={type:"unknown",colIndex:{min:0,max:0}},r=0,n;for(let a of t){if(n=a.split(":"),n.length===2){let[i,c]=n;if(i in this.allowedConfigs){let s=this.allowedConfigs[i];s&&s.includes(c)&&(e[i]=i==="includeShinies"?C(c):c)}}r++}return e}getWorksheetValues(t,e,r){return this.gss.getBatchValues(t(),e,this.apiKey).pipe(y(n=>(n.valueRanges.forEach(a=>{let i=a.range.split("!")[0],c=this.slugifySheetName(i),s=r.find(p=>this.slugifySheetName(p.slug)===c);if(s){let p=[];if(s.config?.type==="livingDex"){let v=[];a.values?.forEach(u=>{let d={slug:"",regular:!1,shiny:!1};u.forEach((m,f)=>{let l=s.headerIndex[f].trim();if(!(l===""||l==="dex"&&m.trim()==="")&&!["shinyIcon","icon","icon","dex"].includes(l))switch(l){case"shinyOwned":d.shiny=C(m.toLowerCase().trim());break;case"regularOwned":d.regular=C(m.toLowerCase().trim());break;case"pokemon":d.slug=this._generateIconSlug(m.trim());break}}),v.push(d)}),this.spreadsheet?.livingDexChecklist.push(...v);return}a.values?.forEach(v=>{let u={moves:[],evs:{},ivs:{}};v.forEach((d,m)=>{let f=s.headerIndex[m].trim();if(!(f===""||f==="dex"&&d.trim()==="")&&!["icon","egg"].includes(f))switch(f){case"hasHA":u.hasHiddenAbility=d.trim()==="x";break;case"move1":case"move2":case"move3":case"move4":Array.isArray(u.moves)&&u.moves.push(d);break;case"owned":u.isOwned=d.trim()==="x";break;case"hp":case"atk":case"def":case"spa":case"spd":case"spe":u.ivs&&(u.ivs[f]=d);break;case"evhp":case"evatk":case"evdef":case"evspa":case"evspd":case"evspe":u.evs&&(u.evs[f]=d);break;case"isShiny":u.isShiny=d.trim()!=="";break;case"ball":u.ball=d.replace(" Ball","").trim();break;default:u[f]=d}}),u.name&&(u.iconSlug=this._generateIconSlug(u.name)),u.isOwned=u.isOwned||s.config?.type==="Valuables",u.dex&&p.push(u)}),s.data=p}}),b(r))))}_generateIconSlug(t){let e=t.toLowerCase().replace("nidoran \u2640","nidoran-f");return e=e.replace("nidoran \u2642","nidoran-m"),e=new R().transform(e),e=e.replace("-antique",""),e=e.replace("-gigantamax","-gmax"),e=e.replace("-low-key-gmax","-gmax"),e}};o.\u0275fac=function(e){return new(e||o)},o.\u0275prov=S({token:o,factory:o.\u0275fac,providedIn:"root"});let h=o;return h})();var xe=(()=>{let o=class o{loadCachedSpreadsheet(t){let e=localStorage.getItem(this._SPREADHSEET_CACHE_KEY);if(e){let r=JSON.parse(e);if(r.id===t)return this.currentSpreadsheetRef.set(r.value),!0}return!1}constructor(){this.spreadsheetService=g(U),this.apiKey=g(I),this._searchHistory=k([]),this.currentSpreadsheetId=k(""),this.currentSpreadsheetRef=this.spreadsheetService.getSpreadsheet(this.currentSpreadsheetId,this.apiKey),this.currentSpreadsheet=N({source:()=>this.currentSpreadsheetRef.value(),computation:(t,e)=>t||e?.value}),this.currentSearchTerm=k(""),this.searchResult=this.spreadsheetService.getSpreadsheet(this.currentSearchTerm,this.apiKey),this.sheetURLPath=E(()=>{let t=this.currentSpreadsheetRef.value();return t?.username?`u/${t.username}`:t?.id??""}),this._SPREADHSEET_CACHE_KEY="cachedSpreadsheet",x(()=>{let t=this.searchResult.value();t&&this.saveToHistory(t)}),x(()=>{let t=this.currentSpreadsheetRef.value();t&&localStorage.setItem(this._SPREADHSEET_CACHE_KEY,JSON.stringify({id:t.id,value:t}))}),localStorage.getItem("spreadsheetHistory")?this._searchHistory.set(JSON.parse(localStorage.getItem("spreadsheetHistory")??[].toString())):localStorage.setItem("spreadsheetHistory",JSON.stringify([])),this._currentSpreadsheet$=new P({title:"",hasBreedables:!1,hasValuables:!1,worksheets:[],livingDexChecklist:[],id:""})}getCurrentSpreadsheet$(){return this._currentSpreadsheet$}updateCurrentSpreadsheet(t){this.currentSpreadsheetRef.set(t)}getSpreadsheetHistory$(){return this._searchHistory}convertApiErrors(t){let e={state:"unknown",message:""};switch(t){case 429:e.message="Too many requests: Google request limit reached, try again later.";break;case 404:e.message="Cannot find a spreadsheet with given ID.";break;default:e.message="Unknown Error: please check the given ID and publish your sheet if not already.";break}return e}saveToHistory(t){this._searchHistory.update(e=>{let r=e.findIndex(n=>n.id===t.id);return r!==-1&&e.splice(r,1),e.unshift({title:t.title,id:t.id,saveDate:new Date().toTimeString()}),localStorage.setItem("spreadsheetHistory",JSON.stringify(e)),[...e]})}};o.\u0275fac=function(e){return new(e||o)},o.\u0275prov=S({token:o,factory:o.\u0275fac,providedIn:"root"});let h=o;return h})();export{I as a,xe as b};
