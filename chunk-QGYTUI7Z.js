import{a as x,g as w}from"./chunk-7YUFRYV5.js";import{o as _,p as $,w as N}from"./chunk-MC2DVP3H.js";import{R as S,X as y,_ as D,aa as g,ea as H,g as E,ja as A,k as v,o as B,pa as k,qc as P,rc as I,sc as R}from"./chunk-HDOEFQUA.js";var j=(()=>{class h{constructor(){this._httpClient=g($),this._spreadsheetFields=["spreadsheetId","properties.title","sheets.properties","sheets.properties.sheetId","sheets.properties.title","sheets.properties.gridProperties.rowCount","sheets.properties.gridProperties.frozenRowCount","sheets.properties.gridProperties.columnCount","sheets.properties.gridProperties.frozenColumnCount"]}getSpreadsheet(t,e){return this._httpClient.get(`https://sheets.googleapis.com/v4/spreadsheets/${t}?includeGridData=false&fields=${this._spreadsheetFields.join(",")}&key=${e}`)}getBatchValues(t,e,i){let r=new _;for(let o of e)r=r.append("ranges",o);return this._httpClient.get(`https://sheets.googleapis.com/v4/spreadsheets/${t}/values:batchGet?key=${i}`,{params:r})}static{this.\u0275fac=function(e){return new(e||h)}}static{this.\u0275prov=y({token:h,factory:h.\u0275fac,providedIn:"root"})}}return h})();var C=new D("API_KEY");var L=(()=>{class h{constructor(){this.apiKey=g(C),this.injector=g(A),this.spreadsheet=void 0,this.gss=g(j),this.slugifyPipe=g(x),this.bannedSheets=["Welcome","Living Dex","Shiny Living Dex","Breedables Overview","Alcremie","Tool:Breeding","Tool: Move Lookup","Breedables Ball Legality","Ban Checker","DB:Abilities","DB:Balls","DB:Pokemon","DB:LevelMoves","DB:Items","DB:Misc","DB:Moves","DB:Types","DB:Natures","Resource Gen7 (Backup)","Ban List"],this.possibleHeaders=["dex","name","ability","owned","hasHA","ratio","move1","move2","move3","move4","nature","ball","gender","ot","amount","notes","event","isShiny","level","hp","atk","def","spa","spd","spe","item","id","dates","proof","tradeHistory","disclosure","lang","evhp","evatk","evdef","evspa","evspd","evspe","regularOwned","shinyOwned","slug"],this.allowedConfigs={type:["Valuables","Breedables","livingDex"],subType:["RNGs","Legendaries","Shinies","Competitives","Events"],ball:["Dream","Safari","Sport","Beast","Fast","Moon","Heavy","Love","Lure","Level","Friend","Pok\xE9","Great","Ultra","Premier","Dive","Luxury","Nest","Net","Repeat","Timer","Quick","Dusk","Heal"],includeShinies:["true","false"]}}getSpreadsheet(t,e){let i;return H(this.injector,()=>N({params:()=>({spreadsheetId:t()}),stream:({params:r})=>r.spreadsheetId?this.gss.getSpreadsheet(r.spreadsheetId,e).pipe(S(o=>{if(!r.spreadsheetId)return v();i={id:t(),title:o.properties.title,worksheets:[],livingDexChecklist:[]},this.spreadsheet=i;let l=o.sheets.filter(a=>!this.bannedSheets.includes(a.properties.title));return this._getWorksheets(t,l).pipe(S(a=>(i.worksheets=a,this.spreadsheet=i,v(i))),B(a=>{for(let s of a.worksheets)if(s.data){if(s.ownedEntries=(s.data??[]).filter(d=>d.isOwned).length,s.config?.type==="Valuables"&&s.config?.subType==="Shinies")for(let d of s.data)d.isShiny=!0;if(s.config?.type==="Breedables"&&s.config?.ball)for(let d of s.data)d.ball=s.config?.ball}return a.hasBreedables=a.worksheets.some(s=>s.config?.type==="Breedables"),a.hasValuables=a.worksheets.some(s=>s.config?.type==="Valuables"),a.hasBreedables&&(a.overviewEntries=this.buildOverviewEntries(a.worksheets.filter(s=>s.config?.type==="Breedables"&&s.config?.ball))),a}))})):v(void 0)}))}buildOverviewEntries(t){let e={};return t.forEach(i=>{let r=i.config?.ball?.toLowerCase(),o=i.data;r&&(e[r]={},o&&o.forEach(l=>{let a=l;e[r][a.iconSlug]=a}))}),e}getConfigs(t,e,i){return this.gss.getBatchValues(t(),e,this.apiKey).pipe(S(r=>{let o=[];for(let l of r.valueRanges){let a=l.values?.[0]?.indexOf("config")??-1;if(a===-1)continue;let s=l.values.map(c=>c[a]).filter(Boolean);s.shift();let d=this.getWorksheetConfig(s),m=l.range.split("!")[0],n=this.slugifySheetName(m),p=i.find(c=>this.slugifySheetName(c.properties.title)===n),f=0,u=0;if(l.values[0].some((c,b)=>{if(this.possibleHeaders.includes(c))return f=b,!0}),l.values[0].slice().reverse().some((c,b)=>{if(this.possibleHeaders.includes(c))return u=l.values[0].length-1-b,!0}),d.type!=="unknown"){d.colIndex={min:f,max:u};let c={id:"0",title:m,slug:n,config:d,gridProperties:p?.properties.gridProperties??{columnCount:0,rowCount:0},headerIndex:l.values[0].slice(f,u+1),valueRange:""},b=`${this.numberToColumnName(c.config?.colIndex.min??0)}${(c.gridProperties.frozenRowCount??0)+1}`,T=`${this.numberToColumnName(c.config?.colIndex.max??0)}${c.gridProperties.rowCount}`;c.valueRange=`${c.title}!${b}:${T}`,c.title=m.replace(/'/g,""),o.push(c)}}return v(o)}))}_getWorksheets(t,e){let i=e.map(r=>`${r.properties.title}!A1:ZZ5`);return this.getConfigs(t,i,e).pipe(S(r=>{let o=r.map(l=>l.valueRange);return this.getWorksheetValues(t,o,r)}))}numberToColumnName(t){let o="";for(;t>=0;)o=String.fromCharCode(t%26+97)+o,t=Math.floor(t/26)-1;return o.toUpperCase()}slugifySheetName(t){let e=this.slugifyPipe.transform(t);return e[0]==="'"&&(e=e.substr(1)),e[e.length-1]==="'"&&(e=e.substr(0,e.length-1)),e}getWorksheetConfig(t){let e={type:"unknown",colIndex:{min:0,max:0}},i=0,r;for(let o of t){if(r=o.split(":"),r.length===2){let[l,a]=r;if(l in this.allowedConfigs){let s=this.allowedConfigs[l];s&&s.includes(a)&&(e[l]=l==="includeShinies"?w(a):a)}}i++}return e}getWorksheetValues(t,e,i){return this.gss.getBatchValues(t(),e,this.apiKey).pipe(S(r=>(r.valueRanges.forEach(o=>{let l=o.range.split("!")[0],a=this.slugifySheetName(l),s=i.find(d=>this.slugifySheetName(d.slug)===a);if(s){let d=[];if(s.config?.type==="livingDex"){let m=[];o.values?.forEach(n=>{let p={slug:"",regular:!1,shiny:!1};n.forEach((f,u)=>{let c=s.headerIndex[u].trim();if(!(c===""||c==="dex"&&f.trim()==="")&&!["shinyIcon","icon","icon","dex"].includes(c))switch(c){case"shinyOwned":p.shiny=w(f.toLowerCase().trim());break;case"regularOwned":p.regular=w(f.toLowerCase().trim());break;case"pokemon":p.slug=this._generateIconSlug(f.trim());break}}),m.push(p)}),this.spreadsheet?.livingDexChecklist.push(...m);return}o.values?.forEach(m=>{let n={moves:[],evs:{},ivs:{}};m.forEach((p,f)=>{let u=s.headerIndex[f].trim();if(!(u===""||u==="dex"&&p.trim()==="")&&!["icon","egg"].includes(u))switch(u){case"hasHA":n.hasHiddenAbility=p.trim()==="x";break;case"move1":case"move2":case"move3":case"move4":Array.isArray(n.moves)&&n.moves.push(p);break;case"owned":n.isOwned=p.trim()==="x";break;case"hp":case"atk":case"def":case"spa":case"spd":case"spe":n.ivs&&(n.ivs[u]=p);break;case"evhp":case"evatk":case"evdef":case"evspa":case"evspd":case"evspe":n.evs&&(n.evs[u]=p);break;case"isShiny":n.isShiny=p.trim()!=="";break;case"ball":n.ball=p.replace(" Ball","").trim();break;default:n[u]=p}}),n.name&&(n.iconSlug=this._generateIconSlug(n.name)),n.isOwned=n.isOwned||s.config?.type==="Valuables",n.dex&&d.push(n)}),s.data=d}}),v(i))))}_generateIconSlug(t){let e=t.toLowerCase().replace("nidoran \u2640","nidoran-f");return e=e.replace("nidoran \u2642","nidoran-m"),e=new x().transform(e),e=e.replace("-antique",""),e=e.replace("-gigantamax","-gmax"),e=e.replace("-low-key-gmax","-gmax"),e}static{this.\u0275fac=function(e){return new(e||h)}}static{this.\u0275prov=y({token:h,factory:h.\u0275fac,providedIn:"root"})}}return h})();var oe=(()=>{class h{loadCachedSpreadsheet(t){let e=localStorage.getItem(this._SPREADHSEET_CACHE_KEY);if(e){let i=JSON.parse(e);if(i.id===t)return this.currentSpreadsheetRef.set(i.value),!0}return!1}constructor(){this.spreadsheetService=g(L),this.apiKey=g(C),this._searchHistory=k([]),this.currentSpreadsheetId=k(""),this.currentSpreadsheetRef=this.spreadsheetService.getSpreadsheet(this.currentSpreadsheetId,this.apiKey),this.currentSpreadsheet=R({source:()=>this.currentSpreadsheetRef.value(),computation:(t,e)=>t||e?.value}),this.currentSearchTerm=k(""),this.searchResult=this.spreadsheetService.getSpreadsheet(this.currentSearchTerm,this.apiKey),this.sheetURLPath=P(()=>{let t=this.currentSpreadsheetRef.value();return t?.username?`u/${t.username}`:t?.id??""}),this._SPREADHSEET_CACHE_KEY="cachedSpreadsheet",I(()=>{let t=this.searchResult.value();t&&this.saveToHistory(t)}),I(()=>{let t=this.currentSpreadsheetRef.value();t&&localStorage.setItem(this._SPREADHSEET_CACHE_KEY,JSON.stringify({id:t.id,value:t}))}),localStorage.getItem("spreadsheetHistory")?this._searchHistory.set(JSON.parse(localStorage.getItem("spreadsheetHistory")??[].toString())):localStorage.setItem("spreadsheetHistory",JSON.stringify([])),this._currentSpreadsheet$=new E({title:"",hasBreedables:!1,hasValuables:!1,worksheets:[],livingDexChecklist:[],id:""})}getCurrentSpreadsheet$(){return this._currentSpreadsheet$}updateCurrentSpreadsheet(t){this.currentSpreadsheetRef.set(t)}getSpreadsheetHistory$(){return this._searchHistory}convertApiErrors(t){let e={state:"unknown",message:""};switch(t){case 429:e.message="Too many requests: Google request limit reached, try again later.";break;case 404:e.message="Cannot find a spreadsheet with given ID.";break;default:e.message="Unknown Error: please check the given ID and publish your sheet if not already.";break}return e}saveToHistory(t){this._searchHistory.update(e=>{let i=e.findIndex(r=>r.id===t.id);return i!==-1&&e.splice(i,1),e.unshift({title:t.title,id:t.id,saveDate:new Date().toTimeString()}),localStorage.setItem("spreadsheetHistory",JSON.stringify(e)),[...e]})}static{this.\u0275fac=function(e){return new(e||h)}}static{this.\u0275prov=y({token:h,factory:h.\u0275fac,providedIn:"root"})}}return h})();export{C as a,oe as b};
