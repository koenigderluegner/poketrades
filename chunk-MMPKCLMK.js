import{a as E,b as C,i as _}from"./chunk-GSOLFDRC.js";import{p as N,q as O}from"./chunk-7YGXQX32.js";import{Aa as w,Ec as R,Fc as x,Hc as $,R as S,X as b,_ as H,ba as m,fa as A,g as B,k as y,o as D,oa as P}from"./chunk-PRQZTKAP.js";var L=(()=>{let n=class n{constructor(){this._httpClient=m(O),this._spreadsheetFields=["spreadsheetId","properties.title","sheets.properties","sheets.properties.sheetId","sheets.properties.title","sheets.properties.gridProperties.rowCount","sheets.properties.gridProperties.frozenRowCount","sheets.properties.gridProperties.columnCount","sheets.properties.gridProperties.frozenColumnCount"]}getSpreadsheet(t,e){return this._httpClient.get(`https://sheets.googleapis.com/v4/spreadsheets/${t}?includeGridData=false&fields=${this._spreadsheetFields.join(",")}&key=${e}`)}getBatchValues(t,e,i){let r=new N;for(let c of e)r=r.append("ranges",c);return this._httpClient.get(`https://sheets.googleapis.com/v4/spreadsheets/${t}/values:batchGet?key=${i}`,{params:r})}};n.\u0275fac=function(e){return new(e||n)},n.\u0275prov=b({token:n,factory:n.\u0275fac,providedIn:"root"});let f=n;return f})();var I=new H("API_KEY");var T=(()=>{let n=class n{constructor(){this.apiKey=m(I),this.injector=m(P),this.spreadsheet=void 0,this.gss=m(L),this.slugifyPipe=m(E),this.bannedSheets=["Welcome","Living Dex","Shiny Living Dex","Breedables Overview","Alcremie","Tool:Breeding","Tool: Move Lookup","Breedables Ball Legality","Ban Checker","DB:Abilities","DB:Balls","DB:Pokemon","DB:LevelMoves","DB:Items","DB:Misc","DB:Moves","DB:Types","DB:Natures","Resource Gen7 (Backup)","Ban List"],this.possibleHeaders=["dex","name","ability","owned","hasHA","ratio","move1","move2","move3","move4","nature","ball","gender","ot","amount","notes","event","isShiny","level","hp","atk","def","spa","spd","spe","item","id","dates","proof","tradeHistory","disclosure","lang","evhp","evatk","evdef","evspa","evspd","evspe","regularOwned","shinyOwned","slug"],this.allowedConfigs={type:["Valuables","Breedables","livingDex"],subType:["RNGs","Legendaries","Shinies","Competitives","Events"],ball:["Dream","Safari","Sport","Beast","Fast","Moon","Heavy","Love","Lure","Level","Friend","Pok\xE9","Great","Ultra","Premier","Dive","Luxury","Nest","Net","Repeat","Timer","Quick","Dusk","Heal"],includeShinies:["true","false"]}}getSpreadsheet(t,e){let i;return A(this.injector,()=>_({request:()=>({spreadsheetId:t()}),loader:({request:r})=>r.spreadsheetId?this.gss.getSpreadsheet(r.spreadsheetId,e).pipe(S(c=>{if(!r.spreadsheetId)return y();i={id:t(),title:c.properties.title,worksheets:[],livingDexChecklist:[]},this.spreadsheet=i;let h=c.sheets.filter(a=>!this.bannedSheets.includes(a.properties.title));return this._getWorksheets(t,h).pipe(S(a=>(i.worksheets=a,this.spreadsheet=i,y(i))),D(a=>{for(let s of a.worksheets)if(s.data){if(s.ownedEntries=(s.data??[]).filter(d=>d.isOwned).length,s.config?.type==="Valuables"&&s.config?.subType==="Shinies")for(let d of s.data)d.isShiny=!0;if(s.config?.type==="Breedables"&&s.config?.ball)for(let d of s.data)d.ball=s.config?.ball}return a.hasBreedables=a.worksheets.some(s=>s.config?.type==="Breedables"),a.hasValuables=a.worksheets.some(s=>s.config?.type==="Valuables"),a.hasBreedables&&(a.overviewEntries=this.buildOverviewEntries(a.worksheets.filter(s=>s.config?.type==="Breedables"&&s.config?.ball))),a}))})):y(void 0)}))}buildOverviewEntries(t){let e={};return t.forEach(i=>{let r=i.config?.ball?.toLowerCase(),c=i.data;r&&(e[r]={},c&&c.forEach(h=>{let a=h;e[r][a.iconSlug]=a}))}),e}getConfigs(t,e,i){return this.gss.getBatchValues(t(),e,this.apiKey).pipe(S(r=>{let c=[];for(let h of r.valueRanges){let a=h.values?.[0]?.indexOf("config")??-1;if(a===-1)continue;let s=h.values.map(l=>l[a]).filter(Boolean);s.shift();let d=this.getWorksheetConfig(s),v=h.range.split("!")[0],o=this.slugifySheetName(v),p=i.find(l=>this.slugifySheetName(l.properties.title)===o),g=0,u=0;if(h.values[0].some((l,k)=>{if(this.possibleHeaders.includes(l))return g=k,!0}),h.values[0].slice().reverse().some((l,k)=>{if(this.possibleHeaders.includes(l))return u=h.values[0].length-1-k,!0}),d.type!=="unknown"){d.colIndex={min:g,max:u};let l={id:"0",title:v,slug:o,config:d,gridProperties:p?.properties.gridProperties??{columnCount:0,rowCount:0},headerIndex:h.values[0].slice(g,u+1),valueRange:""},k=`${this.numberToColumnName(l.config?.colIndex.min??0)}${(l.gridProperties.frozenRowCount??0)+1}`,K=`${this.numberToColumnName(l.config?.colIndex.max??0)}${l.gridProperties.rowCount}`;l.valueRange=`${l.title}!${k}:${K}`,l.title=v.replace(/'/g,""),c.push(l)}}return y(c)}))}_getWorksheets(t,e){let i=e.map(r=>`${r.properties.title}!A1:ZZ5`);return this.getConfigs(t,i,e).pipe(S(r=>{let c=r.map(h=>h.valueRange);return this.getWorksheetValues(t,c,r)}))}numberToColumnName(t){let c="";for(;t>=0;)c=String.fromCharCode(t%26+97)+c,t=Math.floor(t/26)-1;return c.toUpperCase()}slugifySheetName(t){let e=this.slugifyPipe.transform(t);return e[0]==="'"&&(e=e.substr(1)),e[e.length-1]==="'"&&(e=e.substr(0,e.length-1)),e}getWorksheetConfig(t){let e={type:"unknown",colIndex:{min:0,max:0}},i=0,r;for(let c of t){if(r=c.split(":"),r.length===2){let[h,a]=r;if(h in this.allowedConfigs){let s=this.allowedConfigs[h];s&&s.includes(a)&&(e[h]=h==="includeShinies"?C(a):a)}}i++}return e}getWorksheetValues(t,e,i){return this.gss.getBatchValues(t(),e,this.apiKey).pipe(S(r=>(r.valueRanges.forEach(c=>{let h=c.range.split("!")[0],a=this.slugifySheetName(h),s=i.find(d=>this.slugifySheetName(d.slug)===a);if(s){let d=[];if(s.config?.type==="livingDex"){let v=[];c.values?.forEach(o=>{let p={slug:"",regular:!1,shiny:!1};o.forEach((g,u)=>{let l=s.headerIndex[u].trim();if(!(l===""||l==="dex"&&g.trim()==="")&&!["shinyIcon","icon","icon","dex"].includes(l))switch(l){case"shinyOwned":p.shiny=C(g.toLowerCase().trim());break;case"regularOwned":p.regular=C(g.toLowerCase().trim());break;case"pokemon":p.slug=this._generateIconSlug(g.trim());break}}),v.push(p)}),this.spreadsheet?.livingDexChecklist.push(...v);return}c.values?.forEach(v=>{let o={moves:[],evs:{},ivs:{}};v.forEach((p,g)=>{let u=s.headerIndex[g].trim();if(!(u===""||u==="dex"&&p.trim()==="")&&!["icon","egg"].includes(u))switch(u){case"hasHA":o.hasHiddenAbility=p.trim()==="x";break;case"move1":case"move2":case"move3":case"move4":Array.isArray(o.moves)&&o.moves.push(p);break;case"owned":o.isOwned=p.trim()==="x";break;case"hp":case"atk":case"def":case"spa":case"spd":case"spe":o.ivs&&(o.ivs[u]=p);break;case"evhp":case"evatk":case"evdef":case"evspa":case"evspd":case"evspe":o.evs&&(o.evs[u]=p);break;case"isShiny":o.isShiny=p.trim()!=="";break;case"ball":o.ball=p.replace(" Ball","").trim();break;default:o[u]=p}}),o.name&&(o.iconSlug=this._generateIconSlug(o.name)),o.isOwned=o.isOwned||s.config?.type==="Valuables",o.dex&&d.push(o)}),s.data=d}}),y(i))))}_generateIconSlug(t){let e=t.toLowerCase().replace("nidoran \u2640","nidoran-f");return e=e.replace("nidoran \u2642","nidoran-m"),e=new E().transform(e),e=e.replace("-antique",""),e=e.replace("-gigantamax","-gmax"),e=e.replace("-low-key-gmax","-gmax"),e}};n.\u0275fac=function(e){return new(e||n)},n.\u0275prov=b({token:n,factory:n.\u0275fac,providedIn:"root"});let f=n;return f})();var ce=(()=>{let n=class n{loadCachedSpreadsheet(t){let e=localStorage.getItem(this._SPREADHSEET_CACHE_KEY);if(e){let i=JSON.parse(e);if(i.id===t)return this.currentSpreadsheetRef.set(i.value),!0}return!1}constructor(){this.spreadsheetService=m(T),this.apiKey=m(I),this._searchHistory=w([]),this.currentSpreadsheetId=w(""),this.currentSpreadsheetRef=this.spreadsheetService.getSpreadsheet(this.currentSpreadsheetId,this.apiKey),this.currentSpreadsheet=$({source:()=>this.currentSpreadsheetRef.value(),computation:(t,e)=>t||e?.value}),this.currentSearchTerm=w(""),this.searchResult=this.spreadsheetService.getSpreadsheet(this.currentSearchTerm,this.apiKey),this.sheetURLPath=R(()=>{let t=this.currentSpreadsheetRef.value();return t?.username?`u/${t.username}`:t?.id??""}),this._SPREADHSEET_CACHE_KEY="cachedSpreadsheet",x(()=>{let t=this.searchResult.value();t&&this.saveToHistory(t)}),x(()=>{let t=this.currentSpreadsheetRef.value();t&&localStorage.setItem(this._SPREADHSEET_CACHE_KEY,JSON.stringify({id:t.id,value:t}))}),localStorage.getItem("spreadsheetHistory")?this._searchHistory.set(JSON.parse(localStorage.getItem("spreadsheetHistory")??[].toString())):localStorage.setItem("spreadsheetHistory",JSON.stringify([])),this._currentSpreadsheet$=new B({title:"",hasBreedables:!1,hasValuables:!1,worksheets:[],livingDexChecklist:[],id:""})}getCurrentSpreadsheet$(){return this._currentSpreadsheet$}updateCurrentSpreadsheet(t){this.currentSpreadsheetRef.set(t)}getSpreadsheetHistory$(){return this._searchHistory}convertApiErrors(t){let e={state:"unknown",message:""};switch(t){case 429:e.message="Too many requests: Google request limit reached, try again later.";break;case 404:e.message="Cannot find a spreadsheet with given ID.";break;default:e.message="Unknown Error: please check the given ID and publish your sheet if not already.";break}return e}saveToHistory(t){this._searchHistory.update(e=>{let i=e.findIndex(r=>r.id===t.id);return i!==-1&&e.splice(i,1),e.unshift({title:t.title,id:t.id,saveDate:new Date().toTimeString()}),localStorage.setItem("spreadsheetHistory",JSON.stringify(e)),[...e]})}};n.\u0275fac=function(e){return new(e||n)},n.\u0275prov=b({token:n,factory:n.\u0275fac,providedIn:"root"});let f=n;return f})();export{I as a,ce as b};
